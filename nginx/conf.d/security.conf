# Security and DDoS Protection Configuration

# Block common exploit attempts
location ~ /\. {
    deny all;
    access_log off;
    log_not_found off;
}

# Block access to backup and source files
location ~ /.*\.(bak|config|sql|fla|psd|ini|log|sh|inc|swp|dist|git|svn|lock|json)$ {
    deny all;
    access_log off;
    log_not_found off;
}

# IP Whitelist/Blacklist
geo $blocked_ip {
    default 0;
    # Add blocked IPs here
    # 1.2.3.4 1;
}

# Country blocking (requires ngx_http_geoip_module)
# geoip_country /usr/share/GeoIP/GeoIP.dat;
# map $geoip_country_code $allowed_country {
#     default yes;
#     CN no;  # Block China
#     RU no;  # Block Russia
# }

# User-Agent blocking
map $http_user_agent $blocked_agent {
    default 0;
    ~*malicious 1;
    ~*bot 0;  # Allow bots by default
    ~*crawler 0;
    ~*spider 0;
    # Add more patterns as needed
}

# Referrer spam blocking
map $http_referer $blocked_referrer {
    default 0;
    ~*spam 1;
    ~*viagra 1;
    ~*casino 1;
    # Add more spam domains
}

# Request method limiting
if ($request_method !~ ^(GET|HEAD|POST|PUT|DELETE|OPTIONS)$) {
    return 444;
}

# Additional rate limiting for sensitive endpoints
limit_req_zone $binary_remote_addr zone=login:10m rate=5r/m;
limit_req_zone $binary_remote_addr zone=api:10m rate=60r/m;

# DDoS Protection Headers
map $http_user_agent $limit_bots {
    default '';
    ~*(google|bing|yandex|msnbot) '';
    ~*(AhrefsBot|SemrushBot|DotBot|MJ12bot) 1;
}

# Custom error pages
error_page 429 /errors/429.html;
error_page 503 /errors/503.html;

location ^~ /errors/ {
    internal;
    root /var/www;
}

# Security headers for all responses
more_set_headers "X-Frame-Options: SAMEORIGIN";
more_set_headers "X-Content-Type-Options: nosniff";
more_set_headers "X-XSS-Protection: 1; mode=block";
more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";
more_set_headers "Permissions-Policy: geolocation=(), microphone=(), camera=()";

# CSP Header for main domain
map $host $csp_header {
    p0rt.xyz "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self' wss: https:; frame-ancestors 'none';";
    default "";
}

more_set_headers "Content-Security-Policy: $csp_header";